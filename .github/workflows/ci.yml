name: æŒç»­é›†æˆ

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  test:
    name: ä»£ç æµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: å®‰è£…uvåŒ…ç®¡ç†å™¨
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: å®‰è£…ä¾èµ–
      run: |
        uv sync --dev

    - name: ä»£ç æ ¼å¼æ£€æŸ¥
      run: |
        uv run black --check .
        uv run isort --check-only .
      continue-on-error: true

    - name: ä»£ç è´¨é‡æ£€æŸ¥
      run: |
        uv run flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
      continue-on-error: true

    - name: è¯­æ³•æ£€æŸ¥
      run: |
        python -m py_compile meeting_extractor.py
        python -m py_compile build.py

  build-test:
    name: æ„å»ºæµ‹è¯• ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: å®‰è£…uvåŒ…ç®¡ç†å™¨
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
      shell: bash

    - name: æ·»åŠ uvåˆ°PATH (Windows)
      if: matrix.os == 'windows-latest'
      run: echo "$env:USERPROFILE\\.cargo\\bin" >> $env:GITHUB_PATH

    - name: æ·»åŠ uvåˆ°PATH (Unix)
      if: matrix.os != 'windows-latest'
      run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: å®‰è£…é¡¹ç›®ä¾èµ–
      run: |
        # Windowså¹³å°ç‰¹æ®Šå¤„ç†volcengine-python-sdkæ„å»ºé—®é¢˜
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          echo "ğŸ”§ Windowså¹³å°ï¼šå¤„ç†volcengine-python-sdkæ„å»ºé—®é¢˜"
          uv cache clean || true
          rm -f uv.lock || true
          # è®¾ç½®æ„å»ºç¯å¢ƒå˜é‡
          export SETUPTOOLS_USE_DISTUTILS=stdlib
          export DISTUTILS_USE_SDK=1
          # å°è¯•å®‰è£…ï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
          uv sync --dev || (
            echo "âš ï¸ æ ‡å‡†å®‰è£…å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨pipå®‰è£…volcengine-python-sdk"
            pip install "volcengine-python-sdk[ark]==3.0.155" --force-reinstall
            uv sync --dev --no-build-isolation
          )
        else
          uv sync --dev
        fi
      shell: bash

    - name: æµ‹è¯•æ„å»ºè„šæœ¬
      run: |
        uv run python build.py --help
      shell: bash

    - name: å¿«é€Ÿæ„å»ºæµ‹è¯• (ä»…æ£€æŸ¥ä¾èµ–)
      run: |
        uv run python -c "
        import sys
        import subprocess
        
        # æ£€æŸ¥PyInstalleræ˜¯å¦å¯ç”¨
        try:
            result = subprocess.run([sys.executable, '-m', 'PyInstaller', '--version'], 
                                  capture_output=True, text=True, check=True)
            print(f'âœ… PyInstallerå¯ç”¨: {result.stdout.strip()}')
        except Exception as e:
            print(f'âŒ PyInstalleræ£€æŸ¥å¤±è´¥: {e}')
            sys.exit(1)
        
        # æ£€æŸ¥ä¸»è¦ä¾èµ–
        try:
            import volcenginesdkarkruntime
            import pydantic 
            import dotenv
            import openpyxl
            print('âœ… ä¸»è¦ä¾èµ–åŒ…æ£€æŸ¥é€šè¿‡')
        except ImportError as e:
            print(f'âŒ ä¾èµ–åŒ…å¯¼å…¥å¤±è´¥: {e}')
            sys.exit(1)
        "
      shell: bash

  dependency-check:
    name: ä¾èµ–å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: å®‰è£…uvåŒ…ç®¡ç†å™¨
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: æ£€æŸ¥ä¾èµ–ç‰ˆæœ¬
      run: |
        uv sync --dev
        echo "=== æ ¸å¿ƒä¾èµ–ç‰ˆæœ¬ ==="
        uv run python -c "
        try:
            import volcenginesdkarkruntime
            print('âœ… volcengine-python-sdkå®‰è£…æˆåŠŸ')
        except ImportError:
            print('âŒ volcengine-python-sdkå¯¼å…¥å¤±è´¥')
        
        try:
            import pydantic
            print(f'âœ… pydanticç‰ˆæœ¬: {pydantic.__version__}')
        except ImportError:
            print('âŒ pydanticå¯¼å…¥å¤±è´¥')
            
        try:
            import dotenv
            print('âœ… python-dotenvå®‰è£…æˆåŠŸ')
        except ImportError:
            print('âŒ python-dotenvå¯¼å…¥å¤±è´¥')
            
        try:
            import openpyxl
            print(f'âœ… openpyxlç‰ˆæœ¬: {openpyxl.__version__}')
        except ImportError:
            print('âŒ openpyxlå¯¼å…¥å¤±è´¥')
        "

    - name: æ£€æŸ¥é”å®šæ–‡ä»¶
      run: |
        if [ -f "uv.lock" ]; then
          echo "âœ… uv.lockæ–‡ä»¶å­˜åœ¨"
          echo "é”å®šæ–‡ä»¶ä¿¡æ¯:"
          head -20 uv.lock
        else
          echo "âš ï¸ uv.lockæ–‡ä»¶ä¸å­˜åœ¨"
        fi 