name: æ„å»ºå’Œå‘å¸ƒå¤šå¹³å°å¯æ‰§è¡Œç¨‹åº

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€tagæ—¶è§¦å‘ï¼Œä¾‹å¦‚v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å·'
        required: true
        default: 'v0.2.0'

env:
  PYTHON_VERSION: '3.11'

jobs:
  build:
    name: æ„å»º ${{ matrix.os }} ç‰ˆæœ¬
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            executable: meeting_extractor_linux
          - os: windows-latest
            platform: windows
            executable: meeting_extractor_windows.exe
          - os: macos-latest
            platform: macos
            executable: meeting_extractor_macos

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: å®‰è£…uvåŒ…ç®¡ç†å™¨
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
      shell: bash

    - name: æ·»åŠ uvåˆ°PATH (Windows)
      if: matrix.os == 'windows-latest'
      run: echo "$env:USERPROFILE\\.cargo\\bin" >> $env:GITHUB_PATH

    - name: æ·»åŠ uvåˆ°PATH (Unix)
      if: matrix.os != 'windows-latest'
      run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

    - name: å®‰è£…é¡¹ç›®ä¾èµ–
      run: |
        uv sync --dev
      shell: bash

    - name: è¿è¡Œæ„å»ºè„šæœ¬
      run: |
        uv run python build.py --clean
      shell: bash

    - name: éªŒè¯æ„å»ºäº§ç‰©
      run: |
        ls -la dist/
      shell: bash

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.executable }}
        path: dist/${{ matrix.executable }}*
        retention-days: 30

  release:
    name: åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è·å–ç‰ˆæœ¬å·
      id: get_version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          echo "tag_name=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      run: |
        mkdir -p release
        find ./artifacts -name "meeting_extractor_*" -type f -exec cp {} ./release/ \;
        ls -la release/

    - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
      id: changelog
      run: |
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        echo "## ğŸ‰ ä¼šè®®ä¾  ${{ steps.get_version.outputs.version }} å‘å¸ƒ" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ğŸ“¦ å¯æ‰§è¡Œæ–‡ä»¶ä¸‹è½½" >> $GITHUB_OUTPUT
        echo "- **Windows**: meeting_extractor_windows.exe" >> $GITHUB_OUTPUT
        echo "- **macOS**: meeting_extractor_macos" >> $GITHUB_OUTPUT
        echo "- **Linux**: meeting_extractor_linux" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ğŸš€ ä½¿ç”¨æ–¹æ³•" >> $GITHUB_OUTPUT
        echo "1. ä¸‹è½½å¯¹åº”å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶" >> $GITHUB_OUTPUT
        echo "2. åˆ›å»º \`.env\` æ–‡ä»¶ï¼Œé…ç½® \`ARK_API_KEY\`" >> $GITHUB_OUTPUT
        echo "3. å‡†å¤‡ä¼šè®®è®°å½•æ–‡æœ¬æ–‡ä»¶" >> $GITHUB_OUTPUT
        echo "4. è¿è¡Œç¨‹åºï¼š\`./meeting_extractor_[å¹³å°] ä¼šè®®è®°å½•.txt\`" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ğŸ“‹ åŠŸèƒ½ç‰¹æ€§" >> $GITHUB_OUTPUT
        echo "- âœ… AIæ™ºèƒ½æå–ä¼šè®®ä»»åŠ¡" >> $GITHUB_OUTPUT
        echo "- âœ… ç”ŸæˆExcelæ ¼å¼ä»»åŠ¡æ¸…å•" >> $GITHUB_OUTPUT
        echo "- âœ… æ”¯æŒä¿¡æ¯å’Œè¡ŒåŠ¨é¡¹åˆ†ç±»" >> $GITHUB_OUTPUT
        echo "- âœ… è·¨å¹³å°æ”¯æŒ (Windows/macOS/Linux)" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ğŸ”§ æŠ€æœ¯ä¿¡æ¯" >> $GITHUB_OUTPUT
        echo "- Pythonç‰ˆæœ¬: ${{ env.PYTHON_VERSION }}" >> $GITHUB_OUTPUT
        echo "- æ„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
        echo "- æäº¤å“ˆå¸Œ: ${{ github.sha }}" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: åˆ›å»ºGitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.tag_name }}
        name: ä¼šè®®ä¾  ${{ steps.get_version.outputs.version }}
        body: ${{ steps.changelog.outputs.CHANGELOG }}
        files: |
          release/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: æ„å»ºé€šçŸ¥
    needs: [build, release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: æ„å»ºæˆåŠŸé€šçŸ¥
      if: needs.build.result == 'success' && needs.release.result == 'success'
      run: |
        echo "ğŸ‰ å¤šå¹³å°æ„å»ºå’Œå‘å¸ƒæˆåŠŸå®Œæˆï¼"
        echo "âœ… Windowsç‰ˆæœ¬æ„å»ºå®Œæˆ"
        echo "âœ… macOSç‰ˆæœ¬æ„å»ºå®Œæˆ"  
        echo "âœ… Linuxç‰ˆæœ¬æ„å»ºå®Œæˆ"
        echo "âœ… GitHub Releaseåˆ›å»ºæˆåŠŸ"

    - name: æ„å»ºå¤±è´¥é€šçŸ¥
      if: needs.build.result == 'failure' || needs.release.result == 'failure'
      run: |
        echo "âŒ æ„å»ºæˆ–å‘å¸ƒè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯"
        echo "BuildçŠ¶æ€: ${{ needs.build.result }}"
        echo "ReleaseçŠ¶æ€: ${{ needs.release.result }}"
        exit 1 